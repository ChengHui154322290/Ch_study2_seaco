function haved(){var e=xigou.getSessionStorage("buy_now_uuid")||"",i={token:xigou.getToken(),type:"3",curpage:"1",uuid:e};xigou.activeUser.haved({requestBody:i,callback:function(e,i){if(i==xigou.dictionary.success)if(null==e)xigou.alert(xigou.dictionary.chineseTips.server.value_is_null);else switch(e.code){case"0":addressData=e.data.list,addressData&&addressData.length>0?($(".null_go").show(),$(".coupon-data").show(),setHtmlView(e),selectCoupon(e.data)):($("div.coupon-data").remove(),$("div.null_go").remove(),$("#gotop").remove(),$(".warm_tip").hide(),$('<div class="empty_box"><div class="empty_box_des"><h2 class="empty_box_des_img coupon"></h2><p>此订单暂无可用的优惠券</p></div></div>').insertAfter("header"));break;case"-100":xigou.alert({message:e.rescode.info||"用户失效，请重新登录。",callback:function(){xigou.removelocalStorage("token"),window.location.href="logon.html"}});break;default:xigou.alert(e.rescode.info||"获取优惠券数据失败")}else xigou.alert("请求失败，详见"+e)}})}function setHtmlView(e){var i={coupon0:[]};if(e&&e.data.list)for(var o in e.data.list){var a=e.data.list[o];i.coupon0.push(a)}for(var t='<div class="empty_box">没有可使用的优惠券</div>',n=[],s=0;s<i.coupon0.length;s++){var c=i.coupon0[s];if(n.push('<div class="ui-flex ui-flex-pack-center ui-flex-align-start">'),n.push('<div class="coupon_selectBtn"><label class="ui-checkbox-s"><input type="checkbox" name="checkbox" onclick="checkSelect(this)" ></label></div>'),n.push('   <div class="coupon-item" cid="'+c.cid+'">'),n.push('<div class="coupon_i coupon_type'+c.type+'" cpid = "'+c.type+'"></div>'),n.push('       <div class="coupon-unused-info">'),n.push('           <div class="item_price"><span>¥</span>'+c.price+"</div>"),n.push('           <div class="coupon-introduce">'),n.push('               <div class="coupon-name">'+c.name+"</div>"),n.push("               <ul>"),c.validtime&&""!=c.validtime&&n.push("                   <li>"+c.validtime+"</li>"),c.rule&&""!=c.rule&&n.push("                   <li>"+c.rule+"</li>"),n.push("               </ul>"),n.push('               <div class="application_scope">适用范围'),n.push('                   <div class="show_application_scope"></div>'),n.push("               </div>"),n.push("           </div>"),n.push('           <div class="item_bottom_line" id="info_bottom_line"></div>'),n.push("       </div>"),n.push('       <div class="application_scope_info" style="display: none">'),n.push('           <div class="application_scope_info_bg">'),n.push("               <ul>"),c.scope)for(var l=0;l<c.scope.length;l++)n.push("                   <li>"+c.scope[l]+"</li>");n.push("               </ul>"),n.push("           </div>"),n.push('           <div class="item_bottom_line"></div>'),n.push("       </div>"),n.push("   </div>"),n.push("</div>")}$(".coupon-unused").html(0==n.length?t:n.join("")),$(".coupon-unused").html(0==n.length?t:n.join("")),$(".application_scope")[xigou.events.click](function(){var e=$(this).parents(".coupon-item"),i=e.find("#info_bottom_line"),o=e.find(".application_scope_info"),a=$(this).attr("show");1==a?($(this).attr("show",0),i.show(),o.hide()):($(this).attr("show",1),i.hide(),o.show())})}function checkSelect(e){var i=(e.checked,document.getElementById("coupon-unused").getElementsByTagName("input")),o=$(e).parents(".coupon_selectBtn").siblings(".coupon-item").find(".coupon_i").attr("cpid"),a=document.getElementsByClassName("coupon_type0");if("0"==o)for(var t=0;t<i.length;t++)e!=i[t]&&(i[t].checked=!1);else if("1"==o)for(var t=0;t<a.length;t++)a[t].parentNode.parentNode.getElementsByTagName("input")[0].checked=!1}function selectCoupon(e){$(".confirm_coupon").on("click",function(){for(var i=[],o=$(".coupon-unused input:checked"),a=o.parents(".coupon_selectBtn").siblings(".coupon-item"),t=0;t<a.length;t++){var n=$(a[t]).attr("cid");if(n)for(var s=0;s<e.list.length;s++)e.list[s].cid==n&&i.push(e.list[s])}xigou.setSessionStorage("clearing_select_coupon",i,!0);var c=document.referrer;window.location.href=c?c:"settle.html"})}function setHtml(e){var i={coupon0:[],coupon1:[],coupon2:[]},o=xigou.getSessionStorage("clearing_select_coupon",!0);if(e&&e.data.list)for(var a in e.data.list){var t=e.data.list[a];i.coupon0.push(t)}for(var n='<div class="list" num="#cid#"><div class="detail"><div class="l"><span><label class="one_radio-button radio"><input type="radio" name="lnvoice" #checked#><div class="one_radio-button__checkmark"></div></label> <b>#name#</b></span><i>#rule#</i></div><div class=""><span>#validtime#</span></div><br class="clear"></div></div>',s=[],c="",l=0;l<i.coupon0.length;l++)c="",o&&(c=o.num==i.coupon0[l].num?'checked="true"':""),s.push(n.replace("#name#",i.coupon0[l].name).replace("#rule#",i.coupon0[l].rule).replace("#cid#",i.coupon0[l].cid).replace("#validtime#",i.coupon0[l].validtime));$("#normal").html(s.join("")),$("#normal .list")[xigou.events.click](function(){var e=$(this).find("input[name='lnvoice']"),i=e.prop("checked");e.prop("checked",!i)}),$(".cfmBtn")[xigou.events.click](function(){xigou.removeSessionStorage("clearing_select_coupon");for(var e=$("#normal").find("input[name='lnvoice']"),i=0;i<e.length;i++){var o=$(e[i]).prop("checked");if(o){var a=$(e[i]).parents(".list").attr("num");xigou.setSessionStorage("clearing_select_coupon",getAddData(a),!0);break}}var t=xigou.getQueryString("backpage");window.location.href=t?t+"?holdTime=1#redenvelopes":"clearing.html?holdTime=1#redenvelopes"}),$("[name='lnvoice']").change(function(){return this.checked=!this.checked,!1})}function getAddData(e){var i=null;for(var o in addressData)if(addressData[o].num==e){i=addressData[o];break}return i}$(function(){xigou.getLoginUserInfo({callback:function(e,i){i==xigou.dictionary.success&&(setbackpage(),haved(1))}})});var addressData,tuntype=xigou.getQueryString("tuntype"),backpage,setbackpage=function(){backpage=xigou.getQueryString("backpage"),backpage&&$("a.back").attr("href",backpage+"?holdTime=1")};
function initChangeBtn(){var e=$(".btn");e[xigou.events.click](function(){var e=$(".redeemcode").val();if(""==$.trim(e))return $.dialog({title:"",content:"请输入兑换码",button:["确认"]}),!1;var i={token:xigou.getToken(),ccode:e,sendtype:1};xigou.redeemManager.exchange({requestBody:i,callback:function(e,i){if(i==xigou.dictionary.success)if(null==e)$.tips({content:xigou.dictionary.chineseTips.server.value_is_null,stayTime:2e3,type:"warn"});else switch(e.code){case"0":setExchangeInfo(e.data),initRecentChangeList();break;default:$.dialog({title:"",content:e.msg||"验证失败",button:["确认"]})}else $.tips({content:"请求失败，详见"+e,stayTime:2e3,type:"warn"})}})})}function InitWeixin(){xigou.loading.open();var e=[],i=location.href.split("#")[0].replace(/&+/g,"%26");e.push("url="+i),xigou.activeUser.config({p:e.join("&"),showLoading:!1,callback:function(e,i){if(i==xigou.dictionary.success&&e&&0==e.code){var t=e.data;wx.config({appId:t.appid,timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["checkJsApi","scanQRCode"]})}}}),xigou.loading.close()}function scancode(){isWeiXin()&&$(".index_scan")[xigou.events.click](function(){var e=$.dialog({title:"",content:"确认扫码核销？",button:["取消","确认"]});e.on("dialog:action",function(e){1==e.index&&wx.scanQRCode({needResult:1,scanType:["qrCode","barCode"],success:function(e){var i=e.resultStr,t={token:xigou.getToken(),ccode:i,sendtype:2};xigou.redeemManager.exchange({requestBody:t,callback:function(e,i){if(i==xigou.dictionary.success)if(null==e)$.tips({content:xigou.dictionary.chineseTips.server.value_is_null,stayTime:2e3,type:"warn"});else switch(e.code){case"0":setExchangeInfo(e.data),initRecentChangeList();break;default:$.dialog({title:"",content:e.msg||"验证失败",button:["确认"]})}else $.tips({content:"请求失败，详见"+e,stayTime:2e3,type:"warn"})}})}})})})}function setExchangeInfo(data){var list=xigou.getLocalStorage("redeemcodechangelist");list=list?eval("("+list.replace(/:null/g,':""')+")"):[],list.unshift(data),list.length>4&&(list=list.slice(0,4)),list=JSON.stringify(list),xigou.setLocalStorage("redeemcodechangelist",list)}function initRecentChangeList(){var e=xigou.getLocalStorage("redeemcodechangelist");e&&(e=JSON.parse(e.replace(/:null/g,':""')));for(var e=$(e),i=[],t=0;t<e.length;t++){{parseFloat(e[t].salesPrice).toFixed(2),e[t].redeemCodeState}i.push('<div class="history_record">'),i.push('<div class="date">核销时间  '+e[t].updateTimeCn.replace(/(.*):\d{2}$/,"$1")+"</div>"),i.push('<div class="history_item">'),i.push('<div class="goods_name">'+e[t].spuName+"</div>"),i.push('<div class="goods_num">兑换码 '+e[t].redeemCode+'<span class="cust">操作账号  '+e[t].updateUser+"</span></div>"),i.push("</div>"),i.push("</div>")}$(".histroy").empty().append("<h3>一   近期核销记录   一</h3>").append(i.join(""))}$(function(){xigou.getLoginUserInfo({callback:function(e,i){i==xigou.dictionary.success?(initChangeBtn(),initRecentChangeList(),InitWeixin()):window.location.href="index.html"}}),isWeiXin()||($("header").show(),$(".index_scan").css({top:"63px"}),$(".search").css({"margin-top":"61px"}))}),wx.ready(function(){wx.checkJsApi({jsApiList:["getNetworkType","previewImage","scanQRCode"],success:function(){}}),scancode(),xigou.loading.close(),xigou.wxreadyalert()}),wx.error(function(){});